<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食選擇題(可複選)</title>
  <style>
    :root {
      --bg: #f7f2e8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #4b5563;
      --line: #e5e7eb;
      --primary: #0f766e;
      --primary-hover: #115e59;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #fff9ef 0%, var(--bg) 60%);
    }
    .wrap {
      width: min(1040px, 94%);
      margin: 24px auto 42px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
    }
    h1 {
      margin: 0 0 8px;
      font-size: clamp(28px, 4vw, 40px);
    }
    .desc {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: clamp(18px, 2.6vw, 22px);
      line-height: 1.5;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .item {
      border: 2px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }
    .item:has(input:checked) {
      border-color: #0f766e;
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.14);
    }
    .pick-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 17px;
      color: var(--muted);
    }
    .pick-row input {
      transform: scale(1.4);
    }
    .photo-link {
      display: block;
      text-decoration: none;
    }
    .photo {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #f3f4f6;
      display: block;
    }
    .body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .name-link {
      margin: 0;
      font-size: 21px;
      line-height: 1.35;
      color: #0c4a6e;
      text-decoration: none;
      font-weight: 700;
    }
    .name-link:hover {
      text-decoration: underline;
    }
    .feature {
      margin: 0;
      color: var(--muted);
      font-size: 17px;
      line-height: 1.5;
      flex-grow: 1;
    }
    .map-link {
      color: #0f766e;
      font-size: 16px;
      text-decoration: none;
      font-weight: 700;
    }
    .map-link:hover {
      text-decoration: underline;
    }
    .btn {
      width: 100%;
      margin-top: 16px;
      border: 0;
      border-radius: 12px;
      background: var(--primary);
      color: #fff;
      padding: 13px 16px;
      font-size: 23px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn:hover {
      background: var(--primary-hover);
    }
    .all-map {
      margin-top: 18px;
      border: 1px solid #bae6fd;
      background: #f0f9ff;
      border-radius: 12px;
      padding: 14px;
    }
    .all-map-title {
      margin: 0 0 10px;
      font-size: 22px;
      color: #0f172a;
    }
    .map-frame {
      width: 100%;
      height: 460px;
      border: 0;
      border-radius: 10px;
      background: #fff;
    }
    .all-map-note {
      margin: 10px 0 0;
      font-size: 15px;
      color: #334155;
    }
    .error {
      color: #b91c1c;
      min-height: 28px;
      margin-top: 8px;
      font-size: 18px;
    }
    .result {
      display: none;
      margin-top: 16px;
      border: 1px solid #99f6e4;
      border-radius: 12px;
      background: #f0fdfa;
      padding: 14px;
      font-size: 18px;
      line-height: 1.6;
    }
    .result ul {
      margin: 8px 0 8px 20px;
      padding: 0;
    }
    .share-link {
      word-break: break-all;
      color: #0c4a6e;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel">
      <h1>美食選擇題(可複選)</h1>
      <p class="desc">請勾選你想吃的店家（可複選）。</p>

      <div class="grid" id="optionsContainer"></div>

      <button class="btn" id="submitBtn" type="button">送出並產生結果連結</button>
      <div class="error" id="errorMsg"></div>
      <div class="result" id="resultBox"></div>

      <div class="all-map" id="allMapBox"></div>
    </section>
  </main>

  <script>
    const options = [
      { name: "すみれ 札幌本店（味噌拉麵天花板）", feature: "味噌濃但不死鹹，蒜香重", image: "images/sumire.webp", query: "すみれ 札幌本店" },
      { name: "かに本家 札幌站前本店（帝王蟹首選）", feature: "帝王蟹、毛蟹多種料理方式；蒸、烤、生食一次體驗", image: "images/kani-honke.jpg", query: "かに本家 札幌駅前本店" },
      { name: "回転寿司 トリトン（CP值壽司王）", feature: "干貝、鮭魚、甜蝦厚切；迴轉壽司價格，專門店品質", image: "images/triton.jpg", query: "回転寿司 トリトン 札幌" },
      { name: "成吉思汗 だるま 本店（烤羊肉名店）", feature: "羊肉完全不腥；配北海道啤酒超爽", image: "images/daruma-lamb.jpg", query: "成吉思汗 だるま 本店" },
      { name: "政寿司 本店（小樽壽司天花板）", feature: "海膽、干貝、鮭魚卵新鮮到誇張；適合一生至少吃一次", image: "images/masa-sushi.jpg", query: "政寿司 本店 小樽" },
      { name: "滝波食堂（爆量海鮮丼）", feature: "鮭魚卵、干貝、海膽堆成山；拍照＋味覺雙滿足", image: "images/takinami.jpg", query: "滝波食堂 小樽" },
      { name: "えびそば一幻（蝦味拉麵）", feature: "整碗蝦味但不腥；湯頭可選濃淡", image: "images/ebisoba-ichigen.jpg", query: "えびそば一幻 札幌本店" },
      { name: "函太郎 新千歲空港店（機場高水準壽司）", feature: "魚料新鮮厚切；不輸市區分店", image: "images/kantaro.jpg", query: "函太郎 新千歳空港店" },
      { name: "串鳥 本店（札幌居酒屋代表）", feature: "雞肉、豬肉、蔬菜串樣樣穩；醬汁偏甜鹹，配啤酒超搭", image: "images/kushidori.jpg", query: "串鳥 本店 札幌" },
      { name: "いただきコッコちゃん（年輕派人氣）", feature: "烤串＋炸雞＋居酒屋菜一次滿足；口味偏重，適合多人", image: "images/kokkochan.jpg", query: "いただきコッコちゃん 札幌" },
      { name: "焼とり 鳥勢（小樽老店）", feature: "傳統炭火烤串；醬香濃郁、價格實在", image: "images/torisei.jpg", query: "焼とり 鳥勢 小樽" }
    ];

    const optionsContainer = document.getElementById("optionsContainer");
    const allMapBox = document.getElementById("allMapBox");
    const submitBtn = document.getElementById("submitBtn");
    const errorMsg = document.getElementById("errorMsg");
    const resultBox = document.getElementById("resultBox");

    function filePathToUrl(path) {
      if (!path) return "";
      if (/^https?:\/\//i.test(path) || path.startsWith("file:///")) return path;
      if (/^[A-Za-z]:\\/.test(path)) return "file:///" + path.replace(/\\/g, "/");
      return path.replace(/\\/g, "/");
    }

    function mapsUrlFromQuery(query) {
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
    }

    function getBaseUrl() {
      return window.location.href.split("?")[0];
    }

    function renderOptions() {
      optionsContainer.innerHTML = options
        .map((item, index) => {
          const imgSrc = filePathToUrl(item.image);
          const mapsUrl = mapsUrlFromQuery(item.query);
          const fallback = `https://placehold.co/800x500?text=${encodeURIComponent(item.name)}`;
          return `
            <article class="item">
              <label class="pick-row">
                <input type="checkbox" name="food" value="${index}" />
                <span>加入我的選擇</span>
              </label>
              <a class="photo-link" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">
                <img class="photo" src="${imgSrc}" alt="${item.name}" onerror="this.onerror=null;this.src='${fallback}'" />
              </a>
              <div class="body">
                <a class="name-link" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${item.name}</a>
                <p class="feature">特色：${item.feature}</p>
                <a class="map-link" href="${mapsUrl}" target="_blank" rel="noopener noreferrer">查看 Google 評價</a>
              </div>
            </article>
          `;
        })
        .join("");
    }

    function renderAllMapSection() {
      const allQuery = options.map((o) => o.query).join(" | ");
      const allMapsUrl = mapsUrlFromQuery(allQuery);
      const embedUrl = `https://www.google.com/maps?q=${encodeURIComponent(allQuery)}&output=embed`;
      allMapBox.innerHTML = `
        <h2 class="all-map-title">全部店家位置（同一張地圖）</h2>
        <iframe class="map-frame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${embedUrl}" title="全部店家地圖"></iframe>
        <p class="all-map-note">若地圖上店家未完整顯示，可用這裡開啟完整清單：<a href="${allMapsUrl}" target="_blank" rel="noopener noreferrer">查看 Google 地圖搜尋結果</a></p>
      `;
    }

    function getSelectedIndexes() {
      return [...document.querySelectorAll("input[name='food']:checked")].map((el) => Number(el.value));
    }

    function restoreSelected(indexes) {
      indexes.forEach((idx) => {
        const target = document.querySelector(`input[name='food'][value='${idx}']`);
        if (target) target.checked = true;
      });
    }

    function showResult(indexes, linkUrl) {
      const listHtml = indexes.map((idx) => `<li>${options[idx].name}</li>`).join("");
      resultBox.style.display = "block";
      resultBox.innerHTML = `
        <strong>已選擇：</strong>
        <ul>${listHtml}</ul>
        把這個連結傳給家人，點開就能看到同一份勾選結果：<br />
        <a class="share-link" href="${linkUrl}">${linkUrl}</a>
      `;
    }

    function readFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const picks = params.get("picks");
      if (!picks) return;

      const indexes = picks
        .split(",")
        .map((v) => Number(v))
        .filter((n) => Number.isInteger(n) && n >= 0 && n < options.length);

      if (indexes.length === 0) return;
      restoreSelected(indexes);

      const link = `${getBaseUrl()}?picks=${indexes.join(",")}`;
      showResult(indexes, link);
    }

    submitBtn.addEventListener("click", () => {
      errorMsg.textContent = "";
      const selectedIndexes = getSelectedIndexes();
      if (selectedIndexes.length === 0) {
        errorMsg.textContent = "請至少勾選一個店家。";
        return;
      }

      const picks = selectedIndexes.join(",");
      const link = `${getBaseUrl()}?picks=${picks}`;
      history.replaceState({}, "", link);
      showResult(selectedIndexes, link);
    });

    renderOptions();
    renderAllMapSection();
    readFromQuery();
  </script>
</body>
</html>
